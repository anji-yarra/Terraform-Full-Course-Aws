AWS Terraform Day - 4

Understanding Terraform State, Remote Backends (S3), and State Locking

When working with Infrastructure as Code (IaC) tools like Terraform, one of the most important concepts to understand is state. Terraform uses state files to map real-world cloud resources to your configuration files. Let’s break down what this means and how features like remote backends and state locking help you manage infrastructure safely and efficiently.

1. Desired State vs Actual State
Desired State

This is what you declare in your Terraform configuration files.
In your example:

resource "aws_s3_bucket" "SampleAWSTerraform" {
  bucket = "awsterrafrombucket"

  tags = {
    Name = "Sample Bucket"
    Environment = "Test"
  }
}


This configuration tells Terraform what you want the infrastructure to look like — the desired state.

Actual State

This refers to the current real state of resources in AWS (or any provider).

When you run terraform plan or terraform apply, Terraform compares:

Desired state (from your .tf files)

Actual state (from AWS)

Terraform then determines what changes are needed to bring actual state in line with the desired state.

2. What Is a Terraform State File?

Terraform stores information about managed resources in a state file, commonly named:

terraform.tfstate


This file contains:

Resource IDs

Metadata

Dependencies

Attributes Terraform needs to track resources

The state file is crucial because without it Terraform would have to scan all cloud resources every time — which is slow and sometimes impossible.

Example Content (simplified)
{
  "resources": [
    {
      "type": "aws_s3_bucket",
      "name": "SampleAWSTerraform",
      "instances": [
        {
          "attributes": {
            "id": "awsterrafrombucket",
            "region": "eu-north-1"
          }
        }
      ]
    }
  ]
}

3. Remote Backend Using S3

Storing the state file locally works for very small projects, but in real environments you should always use a remote backend, like AWS S3.

Your configuration:

terraform {
  backend "s3" {
    bucket        = "awsterraform-remote-backend"
    key           = "dev/terraform.tfstate"
    region        = "eu-north-1"
    use_lockfile  = true
    encrypt       = true
  }
}

What This Means

bucket: S3 bucket where the state will be stored

key: path/name of the state file

region: AWS region

encrypt: enables SSE encryption for state data

use_lockfile: enables state locking via DynamoDB or lockfile mechanism

Why Use S3 for State?

Centralized

Versioned (if S3 versioning is ON)

Durable and secure

Supports collaboration

Prevents local state corruption or loss

4. Remote Backend Backup (S3 Versioning)

If S3 versioning is enabled, every update of the Terraform state creates a new version of the file. This acts as an automatic backup system.

Benefits of S3 versioning for Terraform state:

Track historical changes

Roll back to a previous version if needed

Protect against accidental deletion or corruption

5. What Is State Locking?

Imagine two people running terraform apply at the same time on the same infrastructure.
This can break your environment or corrupt the state file.

State locking prevents this.

With AWS, Terraform typically uses DynamoDB for state locking, but in your config you enabled:

use_lockfile = true


This ensures only one Terraform operation happens at a time. If someone tries to run Terraform while another apply is in progress, they will see:

Error: state is locked

Benefits of State Locking

Prevents concurrent writes

Avoids state corruption

Ensures infrastructure consistency

6. Full Picture: How Terraform Works in Your Setup

You write the desired state in .tf files.

Terraform reads the existing state from S3.

It compares desired vs actual state.

Terraform creates a plan to sync the differences.

It locks the state (using lockfile).

Executes changes in AWS.

Updates the remote state file in S3.

Releases the lock.

This ensures a safe, consistent, collaborative environment.

Conclusion

Understanding Terraform’s actual state, desired state, remote backends, backup versions, and state locking is essential for managing cloud infrastructure reliably. By using S3 for state storage along with locking functionality, you ensure:

Team collaboration

Safe state management

Recovery options via versioning

Protection against concurrent changes

Your Terraform setup already follows best practices — using a remote S3 backend, enabling encryption, and using locking.
